import sys
import numpy as np
import pandas as pd
import pickle
import json

from sklearn.model_selection import train_test_split

from sktime.classification.dictionary_based import IndividualBOSS, ContractableBOSS, BOSSEnsemble
from sktime.classification.hybrid import HIVECOTEV1
from sktime.classification.kernel_based import ROCKETClassifier
from sktime.classification.shapelet_based import ShapeletTransformClassifier
from sktime.contrib.vector_classifiers._rotation_forest import RotationForest
from sktime.classification.interval_based import RandomIntervalSpectralForest, TimeSeriesForestClassifier
from sktime.classification.distance_based import KNeighborsTimeSeriesClassifier
#######################################################
from collections import Counter
########################################

FILE_NAME="300_0.8_models.pckl"
model_key={
    "Rocket_Classifier":"Rocket",
    "Individual_Boss":"IndividualBOSS",
    'RISE':"RISE",
    'TSForest':'TSForest',
    'Shapelet':'Shapelet'
}
models=dict()

with open(FILE_NAME, "rb") as f:
    models_dict=pickle.load(f)

###############################################
def ret_splitted_array(arr,each_sz=300):
    data=[]
    tot_len=len(arr)
    num_parts=tot_len//each_sz
    actual_sz=num_parts*each_sz
    arr=arr[:actual_sz]
    if len(arr)==0:
        return []
    ans=np.array_split(arr, num_parts)
    ans=[list(x) for x in ans]
    # print(type(ans))
    return ans

def get_correct_format(arr):
    ret_arr=[]
    for curr_arr in arr:
        ret_arr.append([pd.Series(curr_arr)])
    return pd.DataFrame(ret_arr)

ans=ret_splitted_array([1,2,3,4,5,6,7,8,9,10,11,12,13,14],6)
print(ans)
ans=get_correct_format(ans)
print(ans)

arr1=[
            -35,
            -5070,
            971,
            -4567,
            165,
            -5272,
            1172,
            -4970,
            1273,
            -4869,
            870,
            -5473,
            971,
            -4466,
            870,
            -4668,
            -12624,
            -15343,
            -10609,
            -15544,
            -9904,
            -15645,
            971,
            -3862,
            2079,
            -4265,
            1072,
            -4668,
            870,
            -3963,
            165,
            -4567,
            1475,
            -4365,
            669,
            -4567,
            669,
            -4265,
            -841,
            -4466,
            -236,
            -5171,
            1978,
            -5070,
            -35,
            -3963,
            367,
            -4063,
            1777,
            -4466,
            -236,
            -3157,
            -35,
            -4365,
            -35,
            -5675,
            1475,
            -15343,
            -2049,
            1374,
            -3459,
            -4164,
            367,
            -5574,
            266,
            -3963,
            770,
            -3056,
            -337,
            -3862,
            -438,
            -3963,
            870,
            -3963,
            467,
            -2855,
            2482,
            -2653,
            -1344,
            -3358,
            -136,
            -4063,
            -35,
            -4063,
            -35,
            -4466,
            266,
            -3761,
            870,
            -3963,
            -136,
            -4063,
            -438,
            -3761,
            -1546,
            -3761,
            -639,
            -3358,
            -13429,
            -3963,
            -236,
            -3358,
            -438,
            -3963,
            -337,
            -4365,
            -35,
            -5171,
            -1244,
            -3761,
            -1344,
            -4063,
            -236,
            -3862,
            -1646,
            -3560,
            -841,
            -3862,
            -337,
            -4869,
            -136,
            -3459,
            -639,
            -4063,
            -941,
            -4063,
            -236,
            -4668,
            -740,
            -3761,
            -236,
            -3963,
            -539,
            -3963,
            -438,
            -4365,
            165,
            -3761,
            -5574,
            -15242,
            -136,
            -1646,
            -35,
            -3661,
            467,
            -3358,
            -35,
            -2754,
            -1042,
            -3661,
            770,
            -4869,
            -539,
            -3862,
            -740,
            -2855,
            -941,
            -2452,
            -136,
            -3761,
            -236,
            -3358,
            -740,
            -3459,
            -841,
            -3661,
            -841,
            -3459,
            -438,
            -2855,
            -1042,
            -3761,
            -1143,
            -3459,
            -1244,
            -2855,
            -639,
            -3459,
            -841,
            -4265,
            -12926,
            -3862,
            -1042,
            -3761,
            -438,
            -3459,
            -136,
            -3661,
            -841,
            -1244,
            -841,
            -3661,
            -1042,
            -2855,
            -539,
            -2956,
            -236,
            -3258,
            -1646,
            -3661,
            -1143,
            -2855,
            -841,
            -2351,
            -1244,
            -4164,
            -1244,
            -3963,
            -740,
            -3560,
            -1042,
            -6984,
            -6078,
            -2855,
            -539,
            1575,
            -2855,
            -1747,
            -2049,
            -2351,
            -1646,
            -14940,
            -740,
            -2251,
            -1042,
            -2351,
            -1445,
            -2251,
            -2452,
            -2351,
            -2452,
            -2150,
            -2150,
            -2351,
            -1948,
            -1445,
            -2653,
            -2855,
            -2049,
            -2452,
            -2351,
            -2150,
            -2049,
            -2351,
            -2150,
            -2049,
            -2150,
            -2049,
            -2150,
            -1747,
            -1244,
            -2251,
            -2653,
            -1747,
            -2351,
            -1747,
            -2351,
            -2956,
            -2452,
            -1445,
            -3560,
            -1848,
            -14738,
            -2150,
            -2351,
            -1646,
            -2653,
            -2351,
            -2855,
            -1948,
            -2452,
            -1244,
            -2553,
            -1244,
            -2855,
            -1948,
            -2553,
            -2251,
            -2956,
            -1848,
            -2452,
            -1646,
            -3358,
            -14940,
            -2452,
            -2855,
            -1848,
            -2150,
            -2553,
            -4970,
            -6078,
            4093,
            -6279,
            -1848,
            -2855,
            -1445,
            -3459,
            -841,
            -2452,
            -2351
        ]


arr2=[
            32576,
            -27848,
            33650,
            -28385,
            33919,
            -28385,
            32308,
            -27848,
            30965,
            -28922,
            32845,
            -23819,
            29353,
            -29459,
            32039,
            -26773,
            31502,
            -27311,
            32576,
            -21402,
            34993,
            -26236,
            31770,
            -23551,
            33650,
            -29728,
            32039,
            -28116,
            32039,
            -29728,
            34456,
            -22477,
            30428,
            -28116,
            35530,
            -25699,
            28011,
            -22208,
            34725,
            -30802,
            32039,
            -23551,
            30428,
            -23819,
            31770,
            -27848,
            36336,
            -23819,
            36067,
            -31876,
            30428,
            -31876,
            30696,
            -18985,
            45198,
            -20865,
            61849,
            -19522,
            44930,
            -23551,
            51912,
            -10660,
            42244,
            -17911,
            36067,
            -18180,
            36336,
            -15494,
            32308,
            -13346,
            38216,
            -10123,
            41438,
            -9049,
            37679,
            -11197,
            34456,
            -15494,
            39559,
            -13346,
            37410,
            -12809,
            38484,
            -9586,
            51106,
            -12540,
            47347,
            -16837,
            39290,
            -5826,
            34456,
            -4215,
            30428,
            1961,
            30696,
            887,
            35799,
            -6632,
            30696,
            6526,
            27742,
            5989,
            19148,
            10823,
            16463,
            15389,
            16194,
            14314,
            16463,
            15657,
            16194,
            15389,
            16194,
            15657,
            16194,
            15120,
            15926,
            15389,
            16463,
            15120,
            16194,
            15389,
            16194,
            15926,
            16194,
            16194,
            16463,
            15120,
            14852,
            15657,
            16463,
            15657,
            16194,
            15657,
            16194,
            15657,
            16731,
            15657,
            13777,
            15657,
            15657,
            15389,
            15657,
            16194,
            16194,
            15657,
            15657,
            15389,
            14583,
            15657,
            17000,
            15120,
            15926,
            15120,
            16194,
            15657,
            15389,
            15657,
            16194,
            16194,
            15657,
            15389,
            16463,
            15120,
            15389,
            15657,
            16463,
            15657,
            16194,
            13777,
            14852,
            13240,
            15120,
            14046,
            15120,
            14314,
            15120,
            13509,
            14852,
            13777,
            17537,
            15389,
            17537,
            15120,
            17537,
            15389,
            16731,
            15657,
            17806,
            14046,
            17537,
            16194,
            17806,
            14852,
            17269,
            14852,
            17269,
            15120,
            17806,
            15389,
            17806,
            15657,
            17269,
            15389,
            16194,
            14583,
            17000,
            15120,
            16463,
            15120,
            17806,
            15389,
            16731,
            14046,
            16194,
            14852,
            16463,
            14852,
            16463,
            14852,
            13509,
            14583,
            15926,
            14583,
            15926,
            15120,
            15389,
            14314,
            15657,
            15389,
            14046,
            12703,
            15389,
            14852,
            15926,
            14583,
            15389,
            14852,
            15120,
            14046,
            15389,
            14314,
            15389,
            14852,
            15389,
            14583,
            15389,
            14583,
            15389,
            14852,
            14852,
            15120,
            15389,
            14852,
            15657,
            14852,
            15120,
            14046,
            15657,
            14852,
            15120,
            12703,
            14852,
            14852,
            14852,
            14314,
            15389,
            14583,
            15120,
            14852,
            14852,
            12166,
            13240,
            13240,
            13509,
            12166,
            13509,
            12435,
            13240,
            11897,
            15389,
            14852,
            14852,
            14046,
            14852,
            15120,
            14852,
            14583,
            14852,
            18611,
            14314,
            14314,
            14852,
            18880,
            6526,
            19954,
            11360,
            14852,
            9749,
            23177
        ]


arr=arr1
arr.extend(arr2)

def get_prediction(input_arr, model_key="RISE"):
    print("Number of data points obtained is ",len(input_arr))
    input_arr=ret_splitted_array(input_arr)
    print("Number of data points obtained after truncation is ",len(input_arr))
    if model_key not in models_dict:
        print("No such model exists")
        return None
    input_arr=get_correct_format(input_arr)

    # key exists
    prediction_labels=models_dict[model_key].predict(input_arr)
    f_dict=Counter(prediction_labels)
    print(f_dict.keys())
    max_f=-1
    best_key=None
    for curr_pred, pred_freq in f_dict.items():
        if pred_freq>=max_f:
            max_f=pred_freq
            best_key=curr_pred
        
    return best_key
    # print("##########################")
    # return prediction_labels

label_ans=get_prediction(arr)







